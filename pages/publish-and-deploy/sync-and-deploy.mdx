import { ListItem, UnorderedList, OrderedList } from "@vastly/ui"
import { Callout } from "nextra-theme-docs"

# Sync and Deploy
This documentation provides an overview of how to utilize the sync and deploy system for applications. This system automates the deployment process, maintains a single source of truth for secrets and environment variables, and ensures consistency across different environments.
## Overview

<Callout>
Ensure the following secrets are configured in the repository settings before proceeding: <br/>
 * `OIDC_IAM_ROLE`: Account specific IAM role to retrieve AWS credentials
</Callout>


The system consists of a few custom actions. These workflows will require some inputs to be passed from one to the other, as well as some optional inputs with default values.
1. **App Specific Workflow**:
    <UnorderedList>
      <ListItem>Triggers on pushes to specific branches and paths</ListItem>
      <ListItem>Allows for manual deployment via the GitHub Actions interface. Users can select the environment (uat, prod) during manual execution</ListItem>
      <ListItem>Deployment library agnostic</ListItem>
    </UnorderedList><br/>
2. **Reusable Actions:**
    <UnorderedList>
      <ListItem>Syncs secrets from DynamoDB to GitHub</ListItem>
      <ListItem>Export environment variables</ListItem>
    </UnorderedList>

## Usage
  **1. Edit the `deploy-app-example.yml` to fit your specific deployment needs. See the `README.md` of your Wave App under Deployment for more info.<br/><br/>**

    <UnorderedList>
      <ListItem>Change the paths in the `on:` section.</ListItem>
      <ListItem>Configure the `options` with the deployment environments that exists in github.</ListItem>
      <ListItem>Replace the path for the `Download .env file` step to point to the app that is being deployed.</ListItem>
      <ListItem>In the space provided, place any custom logic that is needed before deployment.</ListItem>
      <ListItem>In the `Deploy` step, replace the run script with the deploy command of your choosing.</ListItem>
      <ListItem>Lastly, rename the file and names of any steps needed.</ListItem>
    </UnorderedList>

  **2. Trigger Workflow**<br/><br/>
      <UnorderedList>
      <ListItem>By pushing changes to the main branch that affect files in the specified path, example `[apps/client, apps/admin]`</ListItem>
      <ListItem>Or manually trigger via the GitHub Actions UI by selecting the desired environment</ListItem>
      </UnorderedList>

  **3.Monitor Workflow Progress**<br/><br/>
      <UnorderedList>
      <ListItem>Follow the workflow's progress in the GitHub Actions tab.</ListItem>
      <ListItem>Ensure that the app is successfully deployed to the selected environment.</ListItem>
      </UnorderedList>



## Workflow Breakdown
### Inputs
  * `environment`: string <span style={{"color":"orange"}}><i>[defaults to uat]</i></span>

### Reusable Pre-deployment
  #### Sync secrets from DynamoDB to GitHub
      This workflow is designed to dynamically synchronize secrets from an AWS DynamoDB table to GitHub based on environment. By using a single source of truth, we won't have to worry about missing or mismatching secrets or variables.
      * fetches secrets from dynamo
      * fetches secrets from github
      * updates secrets in github with the secrets from dynamo
      * deletes any secrets that do not exist in dynamo

#### Export env
      This workflow uses the `vastly env` service to pull environment specific envs and uploads them as an artifact to be used later in the deployment process

### App Specific Workflow
This workflow will live at the root level of the client account repository, in its `./github/workflows` directory.

  #### Steps
      * Checkout client repo
      * Configure AWS credentials (environment based)
      * Install Node
      * Install pnpm and dependencies
      * Calls the reusable pre-deployment actions from the shared workflows
      * Downloads the env artifact from the previous step (path needs to point to the app being deployed)
      * Any custom app logic necessary for deployment
      * Deploy the app using whichever library: `pnpm sst deploy --stage uat`
      * Deletes the env artifact

## Example

```yaml filename=".github/workflows/deploy-app-example.yml"
name: ðŸ”µ Deploy Client App Example
run-name: Deploy client app example

on:
  push:
    branches:
      - main
    paths:
      # trigger deployments based on changes within a specified path
      - apps/client/**

  workflow_dispatch:
    inputs:
      # specify your environment [local, sandbox, uat, prod]. This must match one of the environments in github
      environment:
        description: "Select the environment to deploy"
        type: choice
        default: uat
        options:
          - uat
          - prod

jobs:
  deploy-client:
    name: Deploy Client App
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # be sure this secret is in place before initial deployment
          role-to-assume: ${{ secrets.OIDC_IAM_ROLE }}
          aws-region: us-east-1

      - name: Node Installation
        uses: actions/setup-node@v4
        with:
          node-version: latest

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
          run_install: |
            - args: [--no-frozen-lockfile]

      - name: Pre-deployment
        uses: companydotcom/shared-workflows/pre-deployment@main
        with:
          # this environment should match the above environment
          environment: ${{ inputs.environment }}
          gh_token: ${{ secrets.VASTLY_ENV_PAT }}

      - name: Download .env file from artifacts
        uses: actions/download-artifact@v4
        with:
          name: env-file
          # depending on the app being deployed, make sure this is pointing to the correct path
          path: ${{ github.workspace }}/apps/client

      ###############################################################################
      #                                                                             #
      #                                                                             #
      #                      Place custom app logic here                            #
      #                                                                             #
      #                                                                             #
      ###############################################################################

      - name: Deploy via SST
        # check path and configure your deploy command. This is an SST example
        working-directory: ./apps/client
        run: |
          pnpm sst deploy --stage ${{ inputs.environment }}

      - name: Clean up
        uses: geekyeggo/delete-artifact@v5
        with:
          name: env-file

```

## Summary
With the above workflow files in place, you can now implement a robust and automated system for syncing secrets and deploying applications across multiple environments. This system ensures that your secrets are always up-to-date and that deployments are consistent and reliable.

### Future Adaptations and Improvements
  - Make the App Specific workflow app agnostic
  - Create a better strategy for injecting the `OIDC` before workflows start



